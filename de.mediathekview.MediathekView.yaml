app-id: de.mediathekview.MediathekView
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
command: de.mediathekview.MediathekView.sh
finish-args:
  - '--share=network' # We need the network to download films
  - '--socket=x11' # Show windows (Java doesn't support wayland yet)
  - '--share=ipc' # Required for X11
  - '--device=dri' # Render things with opengl
  - '--socket=pulseaudio' # Sound
  - '--talk-name=org.freedesktop.Notifications'   # For desktop notifications
  - '--filesystem=xdg-download' # Standard directory for downloads
  # Persist Mediathekview config directories; it doesn't use XDG_CONFIG_HOME unfortunately, see
  # https://github.com/mediathekview/MediathekView/issues/339
  - '--persist=.mediathek3'
  - '--persist=.mediathek.javafx.tool.JFXHiddenApplication/'
  # See https://github.com/flathub/org.freedesktop.Sdk.Extension.openjdk#usage
  - '--env=PATH=/app/bin/:/app/jre/bin:/usr/bin'
modules:
  # See https://github.com/flathub/org.freedesktop.Sdk.Extension.openjdk#usage
  - name: openjdk
    buildsystem: simple
    build-commands: ['/usr/lib/sdk/openjdk17/install.sh']
  # Libnotify for desktop notifications; we build it separately to avoid depending
  # on the entire Gnome runtime.
  - name: libnotify
    buildsystem: meson
    config-opts:
      - -Dtests=false
      - -Dintrospection=disabled
      - -Dman=false
      - -Dgtk_doc=false
      - -Ddocbook_docs=disabled
    sources:
      - type: archive
        url: https://download.gnome.org/sources/libnotify/0.7/libnotify-0.7.9.tar.xz
        sha256: 66c0517ed16df7af258e83208faaf5069727dfd66995c4bbc51c16954d674761
      - type: archive
        url: https://download.gnome.org/sources/gnome-common/3.18/gnome-common-3.18.0.tar.xz
        sha256: 22569e370ae755e04527b76328befc4c73b62bfd4a572499fde116b8318af8cf
  # The mediathekview maven build
  - name: mediathekview-build
    buildsystem: simple
    build-options:
      env:
        PATH: /app/bin:/usr/bin:/usr/lib/sdk/openjdk17/bin
        JAVA_HOME: /usr/lib/sdk/openjdk17/jvm/openjdk-17
    build-commands:
      # The build process mostly follows Arch's PKGBUILD for MediathekView:
      # https://github.com/archlinux/svntogit-community/blob/packages/mediathekview/trunk/PKGBUILD
      - 'mvn -Dmaven.repo.local=.m2/repository/ -Dmaven.test.skip=true clean install -Plinux,install4j-linux'
      - 'install -Dm644 -t "${FLATPAK_DEST}/share/de.mediathekview.MediathekView" target/MediathekView.jar'
      # Icons from the source directory
      - 'install -Dm644 target/MediathekView@x16.png "${FLATPAK_DEST}/share/icons/hicolor/16x16/apps/de.mediathekview.MediathekView.png"'
      - 'install -Dm644 target/MediathekView@x32.png "${FLATPAK_DEST}/share/icons/hicolor/32x32/apps/de.mediathekview.MediathekView.png"'
      - 'install -Dm644 target/MediathekView@x48.png "${FLATPAK_DEST}/share/icons/hicolor/48x48/apps/de.mediathekview.MediathekView.png"'
      - 'install -Dm644 target/MediathekView@x128.png "${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/de.mediathekview.MediathekView.png"'
      - 'install -Dm644 res/MediathekView.svg "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/de.mediathekview.MediathekView.svg"'
    sources:
      - type: archive
        url: 'https://github.com/mediathekview/MediathekView/archive/refs/tags/13.8.1.tar.gz'
        sha512: '7112ebd0c63bbd55b2a5ed8f0880f406cc52b45ff3a7e1e787b217f43f218464e3162ccefa02bf1ee711b359cabc1adaa8c29947ba14aaf2abe3bf3ce89bc9e7'
      - maven-dependencies.json
  # Mediathekview flatpak data, i.e. the desktop file, the launcher script, etc.
  # Split from the JAR build to avoid rebuilding mediathekview when editing the desktop file or the laucher.
  - name: mediathekview-flatpak
    buildsystem: simple
    build-commands:
      # Launcher script
      - 'install -Dm755 -t "${FLATPAK_DEST}/bin" de.mediathekview.MediathekView.sh'
      # Desktop file
      - 'install -Dm644 -t "${FLATPAK_DEST}/share/applications/" de.mediathekview.MediathekView.desktop'
    sources:
      - type: file
        path: de.mediathekview.MediathekView.desktop
      - type: file
        path: de.mediathekview.MediathekView.sh
